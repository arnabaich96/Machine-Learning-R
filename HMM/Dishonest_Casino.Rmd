---
title: "Dishonest Casino (Hidden Markov Model)"
author: "Arnab Aich"
output: 
  html_document:
    toc: true
    highlight: tango
    code_folding: hide
    fig_width: 8
    fig_height: 6
    fig_align: "center"
    self_contained: true
    toc_depth: 3
    toc_float:
      collapsed: true
---

<link rel="stylesheet" type="text/css" href="../styles.css">

```{r,include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	comment = NA,
	echo = TRUE
)
```

# Introduction

In this document, we will implement a Hidden Markov Model (HMM) for the Dishonest Casino problem. The problem is to determine the sequence of states (Fair or Loaded) of a casino based on the observed sequence of outcomes (1-6) of the dice. The casino uses two dice, one fair and one loaded. The fair die has equal probabilities of 1/6 for each face, while the loaded die has probabilities 1/10 for 1-5 and 1/2 for 6.


```{r setup, include=FALSE}
packages = c("HMM","HMMmlselect","ggplot2","gridExtra","plotly","kableExtra","here","readr")
invisible(xfun::pkg_attach(packages))
```

## Defining Necessary Functions
```{r}
Forward = function(v, a, b, pi){
  
  T = length(v)
  M = nrow(a)
  alpha = matrix(0, T, M)
  
  alpha[1, ] = pi*b[, v[1]]
  
  for(t in 2:T){
    tmp = alpha[t-1, ] %*% a
    alpha[t, ] = tmp * b[, v[t]]
  }
  return(alpha)
}
 
Backward = function(v, a, b){
  T = length(v)
  M = nrow(a)
  beta = matrix(1, T, M)
  
  for(t in (T-1):1){
    tmp = as.matrix(beta[t+1, ] * b[, v[t+1]])
    beta[t, ] = t(a %*% tmp)
  }
  return(beta)
}
 
BaumWelch = function(v=pb2, a=A, b=B, pi, n.iter = 100){
 
  for(i in 1:n.iter){
    T = length(v)
    M = nrow(a)
    K=ncol(b)
    alpha = Forward(v, a, b, pi)
    beta = Backward(v, a, b)
    xi = array(0, dim=c(M, M, T-1))
    
    for(t in 1:T-1){
      denominator = ((alpha[t,] %*% a) * b[,v[t+1]]) %*% matrix(beta[t+1,]) 
      for(s in 1:M){
        numerator = alpha[t,s] * a[s,] * b[,v[t+1]] * beta[t+1,]
        xi[s,,t]=numerator/as.vector(denominator)
      }
    }
    
    
    xi.all.t = rowSums(xi, dims = 2)
    a = xi.all.t/rowSums(xi.all.t)
    
    gamma = apply(xi, c(1, 3), sum)  
    gamma = cbind(gamma, colSums(xi[, , T-1]))
    for(l in 1:K){
      b[, l] = rowSums(gamma[, which(v==l)])
    }
    b = b/rowSums(b)
    
  }
  return(list(a = a, b = b, pi = pi))
}
```

## HMM for Dishonest Casino Model
```{r}
# A is the transition probability matrix
A <- matrix(c(0.95, 0.05, 0.05, 0.95), nrow=2, byrow=TRUE)
# B is the emission probability matrix
B <- matrix(c(1/6, 1/6, 1/6, 1/6, 1/6, 1/6, 1/10, 1/10, 1/10, 1/10, 1/10, 1/2), nrow=2, byrow=TRUE)
# pi is the initial state probability vector
pi <- c(0.5, 0.5)
# Hidden states
states = c("Fair","Loaded") 
# Observed States
symbols = seq(1,6)

# Create the model object
casino_model <- initHMM(states,symbols,startProbs = pi,transProbs =  A, emissionProbs =  B)

```



# Import Data
```{r}
pb1 <- as.numeric(read_csv(here("Datasets/hmm_pb1.csv"), col_names = FALSE))

```

## a)

```{r}
# Decoding
Decode = viterbi(casino_model,pb1)

```

### Most Likely sequence

```{r,comment=NA}
ifelse(Decode == "Fair",1,2)
```

## b)

```{r}
# calculating alphas and betas
f = exp(forward(casino_model,pb1))
b = exp(backward(casino_model,pb1))

```

$\mathbf{\alpha^1_{133}/\alpha^2_{133}=}$

```{r,comment=NA}
round(f['Fair',134]/f['Loaded',134], 3)
```

$\mathbf{\beta^1_{133}/\beta^2_{133}=}$

```{r,comment=NA}
round(b['Fair',134]/b['Loaded',134],3)
```



```{r}
pb2 <- as.numeric(read_csv(here("Datasets/hmm_pb2.csv"), 
    col_names = FALSE))
```

## Run the Baum-Welch algorithm
```{r}
casinoModelEst <- baumWelch(casino_model,pb2,maxIterations = 100)

```
## Estimated parameters after 1000 Iterations
$\mathbf{ \pi = }$ (as a stationary distribution to Transition Probability matrix)
```{r,comment=NA}
p = t(casinoModelEst$hmm$transProbs)
P <- t(p[,1]/sum(p[,1]) )
P %>% round(3) %>% kbl(align = rep("c",nrow(p))  ) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),full_width = F)
```
$\mathbf{a=}$
```{r,comment=NA}
casinoModelEst$hmm$transProbs  %>% kbl(align = rep("c",nrow(casinoModelEst$hmm$transProbs))  ) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),full_width = F)
```
$\mathbf{b=}$
```{r,comment=NA}
casinoModelEst$hmm$emissionProbs %>% kbl(align = rep("c",nrow(casinoModelEst$hmm$emissionProbs))  ) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),full_width = F)
```
